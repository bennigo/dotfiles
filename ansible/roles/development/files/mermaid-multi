#!/bin/bash
# mermaid-multi - Generate multi-page PDF from markdown with multiple Mermaid diagrams
# Usage: mermaid-multi <input.md> [output_prefix]

set -e  # Exit on any error

# Check if input file is provided
if [ $# -eq 0 ]; then
    echo "Usage: mermaid-multi <input.md> [output_prefix]"
    echo "Example: mermaid-multi DOWNLOAD_FLOW_DIAGRAM.md"
    echo "Example: mermaid-multi my_docs.md my_diagrams"
    exit 1
fi

INPUT_FILE="$1"
OUTPUT_PREFIX="${2:-diagrams}"

# Check if input file exists
if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: Input file '$INPUT_FILE' not found"
    exit 1
fi

# Check if mmdc is available
if ! command -v mmdc &> /dev/null; then
    echo "Error: mmdc (mermaid-cli) not found. Please install it with: npm install -g @mermaid-js/mermaid-cli"
    exit 1
fi

# Check if puppeteer config exists
PUPPETEER_CONFIG="/tmp/puppeteer-config.json"
if [ ! -f "$PUPPETEER_CONFIG" ]; then
    echo "Creating puppeteer config for --no-sandbox..."
    echo '{"args":["--no-sandbox"]}' > "$PUPPETEER_CONFIG"
fi

echo "🔍 Scanning '$INPUT_FILE' for Mermaid diagrams..."

# Generate individual PDFs
echo "📊 Generating individual PDFs..."
mmdc -p "$PUPPETEER_CONFIG" -i "$INPUT_FILE" -o "$OUTPUT_PREFIX.pdf" -b white

# Find all generated PDF files
PDF_FILES=($(ls ${OUTPUT_PREFIX}-*.pdf 2>/dev/null | sort -V))

if [ ${#PDF_FILES[@]} -eq 0 ]; then
    echo "❌ No Mermaid diagrams found in '$INPUT_FILE'"
    exit 1
fi

echo "✅ Found ${#PDF_FILES[@]} diagram(s): ${PDF_FILES[*]}"

if [ ${#PDF_FILES[@]} -eq 1 ]; then
    # Single diagram - just open it
    echo "📖 Opening single diagram..."
    if command -v zathura &> /dev/null; then
        zathura "${PDF_FILES[0]}" &
    else
        xdg-open "${PDF_FILES[0]}" &
    fi
else
    # Multiple diagrams - combine them
    echo "📚 Combining ${#PDF_FILES[@]} diagrams into multi-page PDF..."

    # Check if pdfunite is available (from poppler-utils)
    if command -v pdfunite &> /dev/null; then
        COMBINED_PDF="${OUTPUT_PREFIX}_combined.pdf"
        pdfunite "${PDF_FILES[@]}" "$COMBINED_PDF"
        echo "✅ Created combined PDF: $COMBINED_PDF"

        # Open the combined PDF
        if command -v zathura &> /dev/null; then
            echo "📖 Opening combined PDF in Zathura..."
            zathura "$COMBINED_PDF" &
        else
            echo "📖 Opening combined PDF..."
            xdg-open "$COMBINED_PDF" &
        fi
    else
        echo "⚠️  pdfunite not found. Install with: sudo apt install poppler-utils"
        echo "📖 Opening individual PDFs instead..."

        # Open all PDFs individually
        for pdf in "${PDF_FILES[@]}"; do
            if command -v zathura &> /dev/null; then
                zathura "$pdf" &
            else
                xdg-open "$pdf" &
            fi
            sleep 0.5  # Small delay between opening files
        done
    fi
fi

echo "🎉 Done!"