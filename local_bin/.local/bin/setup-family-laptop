#!/bin/bash
# =============================================================================
# Family Laptop Setup Script
# =============================================================================
# Creates isolated, minimal credentials for family laptops.
# Each laptop gets its own SSH key and Claude API key - no shared secrets.
#
# Usage:
#   setup-family-laptop <name>
#   setup-family-laptop daughter
#   setup-family-laptop son
#
# What this script does:
#   1. Generates a NEW SSH key specific to this laptop
#   2. Configures Claude API key (you provide it)
#   3. Sets up basic git config (optional)
#
# What this script does NOT do:
#   - Install your GPG key (keeps your master key safe)
#   - Clone your password store (no access to your secrets)
#   - Copy your SSH keys (generates fresh ones)
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo ""
    echo -e "${BLUE}══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}══════════════════════════════════════════════════════════════${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ $1${NC}"
}

# Check for laptop name argument
if [ -z "$1" ]; then
    echo -e "${RED}Error: Please provide a laptop name${NC}"
    echo ""
    echo "Usage: setup-family-laptop <name>"
    echo "Example: setup-family-laptop daughter"
    exit 1
fi

LAPTOP_NAME="$1"
LAPTOP_NAME_LOWER=$(echo "$LAPTOP_NAME" | tr '[:upper:]' '[:lower:]')
YEAR=$(date +%Y)
SSH_COMMENT="${LAPTOP_NAME_LOWER}-laptop-${YEAR}"

print_header "Family Laptop Setup: $LAPTOP_NAME"

echo ""
echo "This script will set up minimal, isolated credentials for this laptop."
echo "Your main GPG key and SSH keys will NOT be copied here."
echo ""
read -p "Continue? [y/N] " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
fi

# =============================================================================
# Step 1: SSH Key Generation
# =============================================================================
print_header "Step 1: SSH Key"

SSH_KEY_PATH="$HOME/.ssh/id_ed25519"

if [ -f "$SSH_KEY_PATH" ]; then
    print_warning "SSH key already exists at $SSH_KEY_PATH"
    echo ""
    cat "$SSH_KEY_PATH.pub"
    echo ""
    read -p "Generate a new key? (will backup existing) [y/N] " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        BACKUP_NAME="id_ed25519.backup.$(date +%Y%m%d%H%M%S)"
        mv "$SSH_KEY_PATH" "$HOME/.ssh/$BACKUP_NAME"
        mv "$SSH_KEY_PATH.pub" "$HOME/.ssh/${BACKUP_NAME}.pub"
        print_info "Backed up existing key to $BACKUP_NAME"
    else
        print_info "Keeping existing SSH key"
        SSH_KEY_EXISTS=true
    fi
fi

if [ -z "$SSH_KEY_EXISTS" ]; then
    echo ""
    echo "Generating new SSH key for this laptop..."
    echo "Comment will be: $SSH_COMMENT"
    echo ""

    mkdir -p "$HOME/.ssh"
    chmod 700 "$HOME/.ssh"

    ssh-keygen -t ed25519 -C "$SSH_COMMENT" -f "$SSH_KEY_PATH"

    print_success "SSH key generated"
fi

echo ""
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  PUBLIC KEY (add this to GitHub/GitLab/etc.)${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo ""
cat "$SSH_KEY_PATH.pub"
echo ""
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"

# =============================================================================
# Step 2: Claude API Key
# =============================================================================
print_header "Step 2: Claude API Key"

CLAUDE_CONFIG_DIR="$HOME/.config/claude-code"
CLAUDE_CONFIG_FILE="$CLAUDE_CONFIG_DIR/config.json"

if [ -f "$CLAUDE_CONFIG_FILE" ]; then
    print_warning "Claude config already exists"
    read -p "Overwrite? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Keeping existing Claude config"
        SKIP_CLAUDE=true
    fi
fi

if [ -z "$SKIP_CLAUDE" ]; then
    echo ""
    echo "You can create a separate API key at: https://console.anthropic.com/settings/keys"
    echo "Recommended: Name it '${LAPTOP_NAME}-laptop' so you can revoke it independently."
    echo ""
    echo "Paste the Claude API key (input is hidden), or press Enter to skip:"
    read -s CLAUDE_KEY
    echo ""

    if [ -n "$CLAUDE_KEY" ]; then
        mkdir -p "$CLAUDE_CONFIG_DIR"
        cat > "$CLAUDE_CONFIG_FILE" << EOF
{
  "api_key": "$CLAUDE_KEY"
}
EOF
        chmod 600 "$CLAUDE_CONFIG_FILE"
        print_success "Claude API key configured"
    else
        print_info "Skipped Claude API key setup"
    fi
fi

# =============================================================================
# Step 3: Git Configuration (Optional)
# =============================================================================
print_header "Step 3: Git Configuration (Optional)"

echo ""
read -p "Set up git user config for this laptop? [y/N] " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    read -p "Git user name: " GIT_NAME
    read -p "Git email: " GIT_EMAIL

    if [ -n "$GIT_NAME" ] && [ -n "$GIT_EMAIL" ]; then
        git config --global user.name "$GIT_NAME"
        git config --global user.email "$GIT_EMAIL"
        git config --global init.defaultBranch main
        git config --global pull.rebase false
        print_success "Git configured for $GIT_NAME <$GIT_EMAIL>"
    else
        print_warning "Skipped - name or email was empty"
    fi
else
    print_info "Skipped git configuration"
fi

# =============================================================================
# Summary
# =============================================================================
print_header "Setup Complete!"

echo ""
echo "This laptop ($LAPTOP_NAME) now has:"
echo ""

if [ -f "$SSH_KEY_PATH" ]; then
    echo -e "  ${GREEN}✓${NC} SSH Key: $SSH_KEY_PATH"
    echo -e "    Fingerprint: $(ssh-keygen -lf "$SSH_KEY_PATH.pub" | awk '{print $2}')"
fi

if [ -f "$CLAUDE_CONFIG_FILE" ]; then
    echo -e "  ${GREEN}✓${NC} Claude API Key: configured"
else
    echo -e "  ${YELLOW}○${NC} Claude API Key: not configured"
fi

if git config --global user.name &>/dev/null; then
    echo -e "  ${GREEN}✓${NC} Git Config: $(git config --global user.name) <$(git config --global user.email)>"
else
    echo -e "  ${YELLOW}○${NC} Git Config: not configured"
fi

echo ""
echo -e "${BLUE}Security notes:${NC}"
echo "  • This laptop has its OWN credentials (not copies of your main keys)"
echo "  • If compromised, revoke only this laptop's keys:"
echo "    - SSH: Remove public key from GitHub/GitLab"
echo "    - Claude: Delete '${LAPTOP_NAME}-laptop' key at console.anthropic.com"
echo "  • Your main credentials remain unaffected"
echo ""

# =============================================================================
# Next Steps
# =============================================================================
echo -e "${BLUE}Next steps:${NC}"
echo "  1. Add the SSH public key above to GitHub/GitLab (if needed)"
echo "  2. Test: ssh -T git@github.com"
echo "  3. Test: claude --version"
echo ""
