#!/bin/bash
set -euo pipefail

# Quick setup script for password-store and dotfiles sync system

BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}Setting up automated sync system...${NC}"
echo

# 1. Make scripts executable
echo -e "${BLUE}[1/5]${NC} Making scripts executable..."
chmod +x ~/.local/bin/dotfiles-sync
chmod +x ~/.config/waybar/scripts/git-sync-status
echo -e "${GREEN}✓${NC} Scripts are executable"
echo

# 2. Source aliases (add to .zshrc if not already there)
echo -e "${BLUE}[2/5]${NC} Checking shell aliases..."
if ! grep -q "aliases-sync.zsh" ~/.config/zsh/.zshrc 2>/dev/null; then
    echo "source ~/.config/zsh/aliases-sync.zsh" >> ~/.config/zsh/.zshrc
    echo -e "${GREEN}✓${NC} Added sync aliases to .zshrc"
else
    echo -e "${GREEN}✓${NC} Sync aliases already configured"
fi
echo

# 3. Test the sync command
echo -e "${BLUE}[3/5]${NC} Testing sync system..."
if dotfiles-sync --status >/dev/null 2>&1; then
    echo -e "${GREEN}✓${NC} Sync command works"
else
    echo -e "${YELLOW}⚠${NC} Sync command had issues (check manually)"
fi
echo

# 4. Ask about systemd timer
echo -e "${BLUE}[4/5]${NC} Systemd timer setup..."
read -p "Enable automatic sync every 4 hours? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    systemctl --user enable --now password-store-sync.timer
    echo -e "${GREEN}✓${NC} Automatic sync enabled"
    systemctl --user status password-store-sync.timer --no-pager
else
    echo -e "${YELLOW}⚠${NC} Automatic sync not enabled (you can enable later)"
fi
echo

# 5. Show next steps
echo -e "${BLUE}[5/5]${NC} Setup complete!"
echo
echo -e "${GREEN}Available commands:${NC}"
echo "  sync              - Sync all repositories"
echo "  sync-status       - Check sync status"
echo "  sync-pass         - Sync password-store only"
echo "  pass-status       - Check password-store git status"
echo
echo -e "${GREEN}Documentation:${NC}"
echo "  ~/.dotfiles/SYNC_WORKFLOW.md - Complete guide"
echo
echo -e "${GREEN}Next steps:${NC}"
echo "  1. Reload shell: exec zsh"
echo "  2. Test sync: sync-status"
echo "  3. Run first sync: sync"
echo
echo -e "${BLUE}Optional:${NC} Add Waybar module for visual status indicator"
echo "  See: ~/.dotfiles/SYNC_WORKFLOW.md"
