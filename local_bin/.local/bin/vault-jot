#!/usr/bin/env bash
# vault-jot â€” Quick capture to Obsidian daily note
# Bound to $mod+Ctrl+j in Sway
#
# Usage:
#   vault-jot                              # rofi popup for input (today)
#   vault-jot Buy milk                     # plain jot to today
#   vault-jot todo Fix thing               # task to today
#   vault-jot todo Fix thing due:2026-03-01  # task with due date
#   vault-jot todo Fix thing @2026-03-01   # task with due date (shorthand)
#   vault-jot tm Call dentist              # jot to tomorrow
#   vault-jot yd Forgot to log             # jot to yesterday
#   vault-jot nw Plan sprint               # jot to next monday
#   vault-jot lw Should have noted this    # jot to last monday
#   vault-jot 2026-03-01 Some note         # jot to specific date
#   vault-jot --help                       # show usage

set -euo pipefail

VAULT_DIR="${HOME}/notes/bgovault"
DAILY_DIR="${VAULT_DIR}/Journal/daily"

# â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_help() {
    cat <<'EOF'
vault-jot â€” Quick capture to Obsidian daily note

USAGE:
  vault-jot [DATE] [todo] <text> [due:YYYY-MM-DD | @YYYY-MM-DD]
  vault-jot                        # rofi popup (today)
  vault-jot --help                 # this message

DATE ALIASES (optional first argument):
  t          today (default)
  tm         tomorrow
  yd         yesterday
  nw         next monday
  lw         last monday
  tomorrow   tomorrow (long form)
  yesterday  yesterday (long form)
  YYYY-MM-DD specific date

TASK MODE:
  Start text with "todo" to create a checkbox task.
  Append due:YYYY-MM-DD or @YYYY-MM-DD for a due date.

EXAMPLES:
  vault-jot Buy milk
  vault-jot tm Call dentist
  vault-jot todo Fix timeout due:2026-03-01
  vault-jot tm todo Review PR @2026-03-02
  vault-jot nw Plan sprint goals
  vault-jot yd Forgot to log meeting
EOF
    exit 0
}

# â”€â”€ Create a daily note if it doesn't exist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Usage: ensure_daily_note YYYY-MM-DD
ensure_daily_note() {
    local note_date="$1"
    local note_file="${DAILY_DIR}/${note_date}.md"

    [[ -f "${note_file}" ]] && return 0

    local prev_date next_date alias now_time created_stamp
    prev_date=$(date -d "${note_date} - 1 day" +%Y-%m-%d)
    next_date=$(date -d "${note_date} + 1 day" +%Y-%m-%d)
    alias=$(date -d "${note_date}" +"ðŸ“… %B %-d, %Y day: %j")
    now_time=$(date +%H:%M)
    created_stamp=$(date +"%Y-%m-%d %H:%M")

    cat > "${note_file}" <<TEMPLATE
---
area: "Journal"
id: ${note_date}
created: ${created_stamp}
aliases:
  - "${alias}"
tags:
  - type/daily-note
project: ""
resource: ""
---

# ${note_date}

<< [[${prev_date}]] | [[${next_date}]] >>

## Skyndiminnispunktar

> FljÃ³tlegar hugmyndir og athugasemdir â€” hreinsaÃ° Ã­ lok dags


## Verkefni dagsins

### ÃÃ¦tlaÃ° Ã­ dag

\`\`\`tasks
not done
happens on ${note_date}
group by filename
short mode
\`\`\`

### TÃ­masett / Yfirstandandi

\`\`\`tasks
not done
due before ${note_date}
limit 10
short mode
\`\`\`

## DagbÃ³k

- ${now_time} â€”

## NÃ³tur dagsins

\`\`\`dataview
TABLE WITHOUT ID
  file.link as "NÃ³ta",
  file.folder as "StaÃ°setning"
FROM "" AND -"Templates" AND -"4.Archive" AND -"Journal"
WHERE file.cday = date("${note_date}")
SORT file.ctime ASC
\`\`\`
TEMPLATE
}

# â”€â”€ Parse date target â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
resolve_date() {
    case "${1:-}" in
        --help|-h)
            show_help
            ;;
        t)
            TARGET_DATE=$(date +%Y-%m-%d)
            return 0
            ;;
        tm|tomorrow)
            TARGET_DATE=$(date -d "tomorrow" +%Y-%m-%d)
            return 0
            ;;
        yd|yesterday)
            TARGET_DATE=$(date -d "yesterday" +%Y-%m-%d)
            return 0
            ;;
        nw)
            # Next monday
            TARGET_DATE=$(date -d "next monday" +%Y-%m-%d)
            return 0
            ;;
        lw)
            # Last monday
            TARGET_DATE=$(date -d "last monday" +%Y-%m-%d)
            return 0
            ;;
        [0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9])
            # Validate the date
            if date -d "$1" +%Y-%m-%d &>/dev/null; then
                TARGET_DATE="$1"
                return 0
            fi
            # Invalid date â€” treat as content
            return 1
            ;;
        *)
            return 1
            ;;
    esac
}

# Default: today
TARGET_DATE=$(date +%Y-%m-%d)
NOW_TIME=$(date +%H:%M)
TODAY=$(date +%Y-%m-%d)

# Try to parse first arg as date target
if [[ $# -gt 0 ]] && resolve_date "$1"; then
    shift
fi

DAILY_FILE="${DAILY_DIR}/${TARGET_DATE}.md"

# â”€â”€ Get input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ $# -gt 0 ]]; then
    # Check for --help anywhere in args
    for arg in "$@"; do
        [[ "$arg" == "--help" || "$arg" == "-h" ]] && show_help
    done
    INPUT="$*"
else
    INPUT=$(rofi -dmenu -p "Jot" -theme-str 'window { width: 600px; }' -lines 0 2>/dev/null) || exit 0
fi

# Exit if empty
[[ -z "${INPUT}" ]] && exit 0

# â”€â”€ Parse date alias from input (handles rofi and CLI the same way) â”€â”€
# If the first word is a date alias, consume it and re-target the date.
FIRST_WORD="${INPUT%% *}"
if resolve_date "${FIRST_WORD}"; then
    # Strip the date alias from input (handle single-word case)
    if [[ "${INPUT}" == *" "* ]]; then
        INPUT="${INPUT#* }"
    else
        INPUT=""
    fi
    DAILY_FILE="${DAILY_DIR}/${TARGET_DATE}.md"
fi

# Exit if input was only a date alias with no text
[[ -z "${INPUT}" ]] && exit 0

# â”€â”€ Create daily note if needed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ensure_daily_note "${TARGET_DATE}"

# â”€â”€ Format the entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "${INPUT,,}" == todo\ * ]]; then
    # Task mode: strip "todo " prefix
    TASK_TEXT="${INPUT:5}"

    # Extract due date: due:YYYY-MM-DD, due: YYYY-MM-DD, or @YYYY-MM-DD
    DUE_DATE=""
    if [[ "${TASK_TEXT}" =~ (due:[[:space:]]?|@)([0-9]{4}-[0-9]{2}-[0-9]{2}) ]]; then
        DUE_DATE="${BASH_REMATCH[2]}"
        # Remove the due date pattern from task text
        TASK_TEXT=$(echo "${TASK_TEXT}" | sed -E 's/(due:[[:space:]]?|@)[0-9]{4}-[0-9]{2}-[0-9]{2}//g' | sed 's/[[:space:]]*$//' | sed 's/[[:space:]]\+/ /g')
    fi

    ENTRY="- [ ] ${TASK_TEXT} âž• ${TODAY}"
    if [[ -n "${DUE_DATE}" ]]; then
        ENTRY="${ENTRY} ðŸ“… ${DUE_DATE}"
    fi
    NOTIFY_MSG="Task â†’ ${TARGET_DATE}: ${TASK_TEXT}"
else
    # Plain jot mode
    ENTRY="- ${INPUT} (${NOW_TIME})"
    NOTIFY_MSG="Jot â†’ ${TARGET_DATE}: ${INPUT}"
fi

# â”€â”€ Append under ## Skyndiminnispunktar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SECTION_LINE=$(grep -n "^## Skyndiminnispunktar" "${DAILY_FILE}" | head -1 | cut -d: -f1)

if [[ -z "${SECTION_LINE}" ]]; then
    # No section found â€” append before ## Verkefni dagsins
    VERKEFNI_LINE=$(grep -n "^## Verkefni dagsins" "${DAILY_FILE}" | head -1 | cut -d: -f1)
    if [[ -n "${VERKEFNI_LINE}" ]]; then
        sed -i "${VERKEFNI_LINE}i\\## Skyndiminnispunktar\n\n> FljÃ³tlegar hugmyndir og athugasemdir â€” hreinsaÃ° Ã­ lok dags\n\n${ENTRY}\n" "${DAILY_FILE}"
    else
        # Fallback: append to end of file
        printf '\n## Skyndiminnispunktar\n\n%s\n' "${ENTRY}" >> "${DAILY_FILE}"
    fi
else
    # Find the next ## heading after Skyndiminnispunktar
    NEXT_HEADING=$(tail -n +"$((SECTION_LINE + 1))" "${DAILY_FILE}" | grep -n "^## " | head -1 | cut -d: -f1)

    if [[ -n "${NEXT_HEADING}" ]]; then
        # Absolute line of the next heading
        NEXT_HEADING_ABS=$((SECTION_LINE + NEXT_HEADING))
        # Start one line before the heading, skip trailing blank lines
        INSERT_LINE=$((NEXT_HEADING_ABS - 1))
        while [[ $INSERT_LINE -gt $SECTION_LINE ]] && \
              [[ -z "$(sed -n "${INSERT_LINE}p" "${DAILY_FILE}" | tr -d '[:space:]')" ]]; do
            INSERT_LINE=$((INSERT_LINE - 1))
        done
        # Insert after last content line (no trailing \n)
        sed -i "$((INSERT_LINE + 1))i\\${ENTRY}" "${DAILY_FILE}"
    else
        # No next heading â€” append to end of file
        printf '%s\n' "${ENTRY}" >> "${DAILY_FILE}"
    fi
fi

# â”€â”€ Output confirmation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${NOTIFY_MSG}"

# Desktop notification (best-effort)
notify-send -t 3000 "Vault Jot" "${NOTIFY_MSG}" -i dialog-information 2>/dev/null || true
