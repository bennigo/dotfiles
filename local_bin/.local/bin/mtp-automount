#!/bin/bash
# MTP Device Automounter
# Handles MTP devices (like YoloBox) that can't use standard udisks2 automounting
# Creates convenient symlinks in /media/$USER/

set -euo pipefail

ACTION="${1:-}"
DEVICE_NAME="${2:-}"

# Configuration: Map USB IDs to friendly names and search patterns
# Format: "VENDOR_ID:PRODUCT_ID" -> "FRIENDLY_NAME"
declare -A MTP_DEVICES=(
    ["18d1:4ee1"]="YoloBox"
    # Add more devices here as needed, e.g.:
    # ["04e8:6860"]="Samsung-Phone"
)

# Map friendly names to GIO search patterns (device identifiers in mtp:// URIs)
# Use ERE syntax (extended regex) - pipe means OR, no escaping needed
declare -A MTP_SEARCH_PATTERNS=(
    ["YoloBox"]="QUALCOMM|KALAMAP"
    # Add more patterns as needed:
    # ["Samsung-Phone"]="Samsung|Galaxy"
)

MOUNT_BASE="/media/${USER}"
GVFS_BASE="/run/user/$(id -u)/gvfs"
LOG_TAG="mtp-automount"

log() {
    logger -t "$LOG_TAG" "$*"
    echo "[$(date '+%H:%M:%S')] $*"
}

get_device_name() {
    local vendor_id="$1"
    local product_id="$2"
    local key="${vendor_id}:${product_id}"

    if [[ -v MTP_DEVICES["$key"] ]]; then
        echo "${MTP_DEVICES[$key]}"
    else
        echo "MTP-${vendor_id}-${product_id}"
    fi
}

find_mtp_uri() {
    local friendly_name="${1:-}"
    local search_pattern=""

    # Look up search pattern from friendly name
    if [[ -n "$friendly_name" ]] && [[ -v MTP_SEARCH_PATTERNS["$friendly_name"] ]]; then
        search_pattern="${MTP_SEARCH_PATTERNS[$friendly_name]}"
    elif [[ -n "$friendly_name" ]]; then
        search_pattern="$friendly_name"
    fi

    if [[ -n "$search_pattern" ]]; then
        gio mount -li 2>/dev/null | grep "activation_root=mtp://" | grep -iE "$search_pattern" | sed 's/.*activation_root=//' | head -1
    else
        # Return first available MTP device
        gio mount -li 2>/dev/null | grep "activation_root=mtp://" | sed 's/.*activation_root=//' | head -1
    fi
}

find_gvfs_path() {
    local pattern="${1:-mtp:}"
    find "$GVFS_BASE" -maxdepth 1 -type d -name "${pattern}*" 2>/dev/null | head -1
}

get_usb_id_for_device() {
    local friendly_name="$1"
    for key in "${!MTP_DEVICES[@]}"; do
        if [[ "${MTP_DEVICES[$key]}" == "$friendly_name" ]]; then
            echo "$key"
            return
        fi
    done
}

mount_mtp_device() {
    local friendly_name="$1"
    local mtp_uri="$2"
    local mount_point="${MOUNT_BASE}/${friendly_name}"
    local max_retries=2
    local retry=0

    log "Mounting $friendly_name..."

    while [[ $retry -lt $max_retries ]]; do
        # Mount via GIO
        local mount_output
        mount_output=$(gio mount "$mtp_uri" 2>&1)
        local mount_result=$?

        if [[ $mount_result -eq 0 ]]; then
            break
        fi

        # Check for MTP device open error
        if echo "$mount_output" | grep -q "Unable to open MTP device"; then
            log "MTP session error, attempting USB reset..."
            local usb_id
            usb_id=$(get_usb_id_for_device "$friendly_name")
            if [[ -n "$usb_id" ]] && command -v usbreset &>/dev/null; then
                sudo usbreset "$usb_id" 2>/dev/null || true
                sleep 3
                # Refresh the URI as device number may change
                mtp_uri=$(find_mtp_uri "$friendly_name")
                if [[ -z "$mtp_uri" ]]; then
                    log "Error: Device not found after USB reset"
                    log "Try physically unplugging and reconnecting the device"
                    return 1
                fi
            fi
            ((retry++))
        else
            log "Warning: GIO mount returned error, checking if already mounted..."
            break
        fi
    done

    # Wait for GVFS to create the mount
    sleep 2

    # Find the GVFS path
    local gvfs_path
    gvfs_path=$(find_gvfs_path)

    if [[ -z "$gvfs_path" ]]; then
        log "Error: GVFS mount not found for $friendly_name"
        log ""
        log "MTP devices can get into a bad state. Try:"
        log "  1. Physically unplug and reconnect the device"
        log "  2. Make sure 'File Transfer' mode is enabled on the device"
        log "  3. Run: sudo usbreset $(get_usb_id_for_device "$friendly_name")"
        return 1
    fi

    # Create symlink
    sudo mkdir -p "$MOUNT_BASE"
    if [[ -L "$mount_point" ]]; then
        sudo rm "$mount_point"
    elif [[ -d "$mount_point" ]]; then
        sudo rmdir "$mount_point" 2>/dev/null || true
    fi

    sudo ln -s "$gvfs_path" "$mount_point"
    log "✓ $friendly_name mounted at $mount_point"

    # Send desktop notification if available
    if command -v notify-send &>/dev/null; then
        notify-send -i drive-removable-media "MTP Device Connected" "$friendly_name mounted at $mount_point"
    fi
}

unmount_mtp_device() {
    local friendly_name="$1"
    local mount_point="${MOUNT_BASE}/${friendly_name}"

    log "Unmounting $friendly_name..."

    # Find and unmount via GIO
    local mtp_uri
    mtp_uri=$(gio mount -l 2>/dev/null | grep -E "mtp://.*$friendly_name|mtp://.*KALAMAP|mtp://.*QUALCOMM" | grep -oP 'mtp://[^ ]+' | head -1)

    if [[ -n "$mtp_uri" ]]; then
        gio mount -u "$mtp_uri" 2>/dev/null || true
    fi

    # Remove symlink
    if [[ -L "$mount_point" ]]; then
        sudo rm "$mount_point"
        log "✓ $friendly_name unmounted"
    fi

    # Send desktop notification if available
    if command -v notify-send &>/dev/null; then
        notify-send -i drive-removable-media "MTP Device Disconnected" "$friendly_name unmounted"
    fi
}

# Handle udev-triggered events
handle_udev_event() {
    local action="$1"
    local vendor_id="${ID_VENDOR_ID:-}"
    local product_id="${ID_MODEL_ID:-}"

    if [[ -z "$vendor_id" || -z "$product_id" ]]; then
        log "Error: Missing device IDs"
        return 1
    fi

    local friendly_name
    friendly_name=$(get_device_name "$vendor_id" "$product_id")

    case "$action" in
        add)
            # Wait for device to settle
            sleep 3
            local mtp_uri
            mtp_uri=$(find_mtp_uri)
            if [[ -n "$mtp_uri" ]]; then
                mount_mtp_device "$friendly_name" "$mtp_uri"
            else
                log "No MTP URI found for $friendly_name"
            fi
            ;;
        remove)
            unmount_mtp_device "$friendly_name"
            ;;
    esac
}

# Interactive mode
case "$ACTION" in
    mount)
        if [[ -n "$DEVICE_NAME" ]]; then
            mtp_uri=$(find_mtp_uri "$DEVICE_NAME")
        else
            mtp_uri=$(find_mtp_uri)
            DEVICE_NAME="MTP-Device"
            # Try to get a better name
            for key in "${!MTP_DEVICES[@]}"; do
                if lsusb | grep -qi "${key/:/ }"; then
                    DEVICE_NAME="${MTP_DEVICES[$key]}"
                    break
                fi
            done
        fi

        if [[ -z "$mtp_uri" ]]; then
            echo "Error: No MTP device found"
            echo "Make sure your device is connected and has file transfer enabled"
            exit 1
        fi

        mount_mtp_device "$DEVICE_NAME" "$mtp_uri"
        ;;

    unmount|umount)
        if [[ -z "$DEVICE_NAME" ]]; then
            # Find mounted MTP devices
            for name in "${MTP_DEVICES[@]}"; do
                if [[ -L "${MOUNT_BASE}/${name}" ]]; then
                    DEVICE_NAME="$name"
                    break
                fi
            done
        fi

        if [[ -z "$DEVICE_NAME" ]]; then
            echo "Error: No mounted MTP device found"
            exit 1
        fi

        unmount_mtp_device "$DEVICE_NAME"
        ;;

    udev)
        # Called from udev rule
        handle_udev_event "$DEVICE_NAME"
        ;;

    list)
        echo "Known MTP devices:"
        for key in "${!MTP_DEVICES[@]}"; do
            echo "  $key -> ${MTP_DEVICES[$key]}"
        done
        echo ""
        echo "Connected MTP devices:"
        gio mount -li 2>/dev/null | grep -B5 "activation_root=mtp://" | grep -E "Volume|activation_root" || echo "  None"
        ;;

    status)
        echo "MTP mount status:"
        for name in "${MTP_DEVICES[@]}"; do
            mount_point="${MOUNT_BASE}/${name}"
            if [[ -L "$mount_point" ]]; then
                target=$(readlink "$mount_point")
                if [[ -d "$mount_point" ]]; then
                    echo "  ✓ $name -> $mount_point (accessible)"
                else
                    echo "  ✗ $name -> $mount_point (broken link)"
                fi
            fi
        done
        ;;

    *)
        echo "MTP Device Automounter"
        echo ""
        echo "Usage: $(basename "$0") <command> [device-name]"
        echo ""
        echo "Commands:"
        echo "  mount [name]    Mount an MTP device (auto-detects if no name given)"
        echo "  unmount [name]  Unmount an MTP device"
        echo "  list            List known and connected MTP devices"
        echo "  status          Show mount status of known devices"
        echo ""
        echo "Examples:"
        echo "  $(basename "$0") mount              # Mount first available MTP device"
        echo "  $(basename "$0") mount YoloBox      # Mount YoloBox specifically"
        echo "  $(basename "$0") unmount YoloBox    # Unmount YoloBox"
        ;;
esac
